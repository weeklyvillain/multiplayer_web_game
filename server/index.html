<!DOCTYPE html>
<html>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <body>
        <img id="player" src="http://localhost:3000/player2.png" style="display: none; width: 50px; height: 50px;">
        <img id="bullet" src="http://localhost:3000/bullet_bill.webp" style="display: none; width: 50px; height: 50px;">
        <canvas id="canvas" style="border-style: solid;"></canvas>
        <script>
            var socket = io('http://localhost:3000');
            
    var can = document.getElementById('canvas');
    can.height = 600; can.width = 800;
    var ctx = can.getContext('2d');
    var playerimg = document.getElementById("player");
    var bulletimg = document.getElementById("bullet");
    var game_objects = [];

    class Bullet {
        constructor(x, y, width, height, vel_x, vel_y, angle, img, context) {
            this.vel_x = vel_x;
            this.vel_y = vel_y;
            this.x = x;
            this.y = y;
            this.width = width;
            this.height = height;
            this.angle = angle;
            this.image = img;
            this.ctx = context;
        }

        draw() {
            var center_x = this.x + this.width/2;
            var center_y = this.y + this.height/2;
            var img = new Image;
            img.src = this.image;

            this.ctx.save();

            this.ctx.translate(center_x, center_y);

            this.ctx.rotate(this.angle * Math.PI/180);
            
            this.ctx.drawImage(this.image, - this.width/2, - this.height/2, this.width, this.height);

            this.ctx.restore();  
        }

        update_position() {
            this.y += this.vel_y;
            this.x += this.vel_x;
        }
    }


    class Player {
        constructor(id, x, y, width, height, vel, rotation_speed, img, context) {
            this.id = id;
            this.vel = vel;
            this.x = x;
            this.y = y;
            this.width = width;
            this.height = height;
            this.image = img;
            this.ctx = context;
            this.speed = 0;
            this.angle_speed = 0;
            this.angle = 0;
            this.center_x = x + width/2;
            this.center_y = y + height/2;
        }
        
        draw() {
            this.center_x = this.x + this.width/2;
            this.center_y = this.y + this.height/2;
            var img = new Image;
            img.src = this.image;

            ctx.save();

            ctx.translate(this.center_x, this.center_y);

            ctx.rotate(this.angle * Math.PI/180);
            
            ctx.drawImage(img, - this.width/2, - this.height/2, this.width, this.height);

            ctx.restore();    
        }

        update_position() {
            this.angle += this.angle_speed;
            if (this.angle > 360) {
                this.angle -= 360
            }
            if (this.angle < -360) {
                this.angle += 360
            }

            if(this.angle > 0){
                this.x += this.speed * -Math.sin(Math.abs(this.angle) * Math.PI / 180);
            } else {
                this.x += this.speed * Math.sin(Math.abs(this.angle) * Math.PI / 180);
            }
            this.y += this.speed * Math.cos(Math.abs(this.angle) * Math.PI / 180);

        }

        shoot() {
            var vel_x;
            if(this.angle > 0){
                vel_x = 5 * Math.sin(Math.abs(this.angle) * Math.PI / 180);
            } else {
                vel_x = 5 * -Math.sin(Math.abs(this.angle) * Math.PI / 180);
            }
            var vel_y = 5 * -Math.cos(Math.abs(this.angle) * Math.PI / 180);
            //Bullet(x, y, width, height, vel_x, vel_y, angle, img, context)
            game_objects.push(new Bullet(this.x + this.width / 2, this.y + this.height / 2, 20, 20, vel_x , vel_y, this.angle - 90, bulletimg, ctx));
            
        }
        key_down(keycode) {
                // left
            if (keycode == 37) {
                this.angle_speed = -this.vel;
            }
         
            // right
            if (keycode == 39) {
                this.angle_speed = this.vel;
            }
         
            // down
            if (keycode == 38) {
                this.speed = -this.vel;
            }
         
            // up
            if (keycode == 40) {
                this.speed = this.vel;
            }
            // space
            if (keycode == 32) {
                this.shoot();
            }
            socket.emit('update player', JSON.stringify(player1))
        }
        key_up(keycode) {
                // left
            if (keycode == 37) {
                this.angle_speed = 0;
            }
         
            // right
            if (keycode == 39) {
                this.angle_speed = 0;
            }
         
            // down
            if (keycode == 38) {
                this.speed = 0;
            }
         
            // up
            if (keycode == 40) {
                this.speed = 0;
            }
            socket.emit('update player', JSON.stringify(player1))
        }
    }


    
    //Player(x, y, width, height, speed, rotation_speed, img, context)
    var player1 = new Player(Math.random(), 200, 200, 40, 40, 4, 4, "http://localhost:3000/player2.png", ctx);
    game_objects.push(player1);

    socket.emit('join', JSON.stringify(player1))

    socket.on('add player', function(data){
        var p = JSON.parse(data);
        console.log(p);
        var new_p = new Player(p.id, p.x, p.y, p.width, p.height, p.speed, p.rotation_speed, p.image, ctx);
        if(!game_objects.find(o => o.id === new_p.id) && new_p.id != player1.id) {
            game_objects.push(new_p);
            socket.emit('join', JSON.stringify(player1));
        }
        game_objects = Array.from(new Set(game_objects));
        console.log(game_objects)
    });

    socket.on('player update', function(data){
        var p = JSON.parse(data);
        for (const obj of game_objects) {
            if(obj.id == p.id) {
                obj.speed = p.speed;
                obj.angle_speed = p.angle_speed;
            }
        }
    });
    window.setInterval(gameloop, 25);
    
    function gameloop() {

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        game_objects.forEach(obj => {
            obj.update_position();
            obj.draw();
        });
    }


  
 
window.addEventListener("keydown", keysPressed, false);
window.addEventListener("keyup", keysReleased, false);
 

 
function keysPressed(e) {
    console.log(e.keyCode);
    player1.key_down(e.keyCode);
    //e.preventDefault();
}
 
function keysReleased(e) {
    player1.key_up(e.keyCode);
}           
    </script>
</body>
</html>